# åˆå¹¶å•å…ƒæ ¼æ‹†åˆ†åŠŸèƒ½ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆ"æ‹†åˆ†æ¯ä¸€è¡Œ"é€‰é¡¹æ²¡æœ‰æ­£ç¡®å®ç°ï¼Œåº”è¯¥æ˜¯å°†Excelä¸­çš„åˆå¹¶å•å…ƒæ ¼æ‹†åˆ†ï¼Œå¹¶å°†åˆå¹¶å•å…ƒæ ¼çš„å†…å®¹æ˜¾ç¤ºåˆ°æ‹†åˆ†çš„æ¯ä¸€è¡Œä¸­ï¼Œè€Œä¸æ˜¯å¤„ç†åˆ†éš”ç¬¦ã€‚

## é—®é¢˜åˆ†æ

### ğŸ” æ ¹æœ¬åŸå› 

1. **åŠŸèƒ½ç†è§£é”™è¯¯**
   - ä¹‹å‰çš„å®ç°é”™è¯¯åœ°å°†"æ‹†åˆ†æ¯ä¸€è¡Œ"ç†è§£ä¸ºå¤„ç†åˆ†éš”ç¬¦
   - å®é™…ä¸Šåº”è¯¥æ˜¯å¤„ç†Excelä¸­çš„åˆå¹¶å•å…ƒæ ¼

2. **åˆå¹¶å•å…ƒæ ¼å¤„ç†ç¼ºå¤±**
   - æ•°æ®å¯¼å…¥æœåŠ¡ä¸­æ²¡æœ‰æ­£ç¡®å¤„ç†åˆå¹¶å•å…ƒæ ¼çš„é€»è¾‘
   - ç¼ºå°‘è·å–åˆå¹¶å•å…ƒæ ¼å€¼çš„åŠŸèƒ½

3. **EPPlusåˆå¹¶å•å…ƒæ ¼APIä½¿ç”¨ä¸å½“**
   - æ²¡æœ‰æ­£ç¡®ä½¿ç”¨EPPlusçš„`MergedCells`å±æ€§
   - ç¼ºå°‘åˆå¹¶å•å…ƒæ ¼èŒƒå›´æ£€æµ‹é€»è¾‘

## ä¿®å¤æ–¹æ¡ˆ

### ğŸ”§ ä¿®å¤1ï¼šDataImportService.cs åˆå¹¶å•å…ƒæ ¼æ”¯æŒ

#### 1.1 ä¿®æ”¹å•å…ƒæ ¼è¯»å–é€»è¾‘
```csharp
// è¯»å–è¡Œæ•°æ®
for (int col = dimension.Start.Column; col <= dimension.End.Column; col++)
{
    var cellValue = GetCellValueWithMergedCells(worksheet, row, col);
    if (cellValue != null)
    {
        hasData = true;
    }

    // æ ¹æ®å­—æ®µæ˜ å°„è·å–å¯¹åº”çš„æ•°æ®åº“å­—æ®µ
    var mapping = normalizedFieldMappings.FirstOrDefault(m => 
        m.ExcelOriginalColumn == GetColumnLetter(col));

    if (mapping != null)
    {
        var dbValue = ConvertCellValue(cellValue, mapping.DataType);
        rowData[SanitizeParameterName(mapping.DatabaseField)] = dbValue;
    }
}
```

#### 1.2 æ·»åŠ åˆå¹¶å•å…ƒæ ¼å€¼è·å–æ–¹æ³•
```csharp
/// <summary>
/// è·å–å•å…ƒæ ¼çš„å€¼ï¼ŒåŒ…æ‹¬åˆå¹¶å•å…ƒæ ¼
/// </summary>
private object? GetCellValueWithMergedCells(ExcelWorksheet worksheet, int row, int col)
{
    // é¦–å…ˆæ£€æŸ¥å½“å‰å•å…ƒæ ¼æ˜¯å¦æœ‰å€¼
    var cell = worksheet.Cells[row, col];
    if (cell.Value != null)
    {
        return cell.Value;
    }

    // å¦‚æœå½“å‰å•å…ƒæ ¼ä¸ºç©ºï¼Œæ£€æŸ¥æ˜¯å¦åœ¨åˆå¹¶åŒºåŸŸå†…
    foreach (var mergedRangeAddress in worksheet.MergedCells)
    {
        var mergedRange = worksheet.Cells[mergedRangeAddress];
        if (IsCellInRange(row, col, mergedRange))
        {
            // è·å–åˆå¹¶åŒºåŸŸçš„å·¦ä¸Šè§’å•å…ƒæ ¼å€¼
            var topLeftCell = worksheet.Cells[mergedRange.Start.Row, mergedRange.Start.Column];
            return topLeftCell.Value;
        }
    }

    return null;
}
```

#### 1.3 æ·»åŠ èŒƒå›´æ£€æµ‹æ–¹æ³•
```csharp
/// <summary>
/// æ£€æŸ¥å•å…ƒæ ¼æ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…
/// </summary>
private bool IsCellInRange(int row, int col, ExcelRange range)
{
    return row >= range.Start.Row && row <= range.End.Row &&
           col >= range.Start.Column && col <= range.End.Column;
}
```

#### 1.4 ä¿®æ”¹SplitRowDataæ–¹æ³•
```csharp
/// <summary>
/// æ‹†åˆ†è¡Œæ•°æ® - å°†åˆå¹¶å•å…ƒæ ¼çš„å†…å®¹æ‹†åˆ†åˆ°æ¯ä¸ªå•ç‹¬çš„å•å…ƒæ ¼ä¸­
/// </summary>
private List<Dictionary<string, object>> SplitRowData(Dictionary<string, object> originalRow)
{
    // ç”±äºDataImportServiceæ²¡æœ‰ç›´æ¥è®¿é—®Excelå·¥ä½œè¡¨çš„æƒé™ï¼Œ
    // æˆ‘ä»¬éœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼æ¥å¤„ç†åˆå¹¶å•å…ƒæ ¼
    // è¿™é‡Œæˆ‘ä»¬è¿”å›åŸå§‹è¡Œï¼Œå®é™…çš„åˆå¹¶å•å…ƒæ ¼å¤„ç†åº”è¯¥åœ¨æ•°æ®è¯»å–é˜¶æ®µè¿›è¡Œ
    return new List<Dictionary<string, object>> { originalRow };
}
```

### ğŸ”§ ä¿®å¤2ï¼šOptimizedDataImportService.cs åˆå¹¶å•å…ƒæ ¼æ”¯æŒ

#### 2.1 ä¿®æ”¹å•å…ƒæ ¼è¯»å–é€»è¾‘
```csharp
// ä½¿ç”¨å†…å­˜æ± ä¼˜åŒ–å­—ç¬¦ä¸²å¤„ç†
for (int col = dimension.Start.Column; col <= dimension.End.Column; col++)
{
    var cellValue = GetCellValueWithMergedCellsOptimized(worksheet, row, col);
    if (cellValue != null)
    {
        hasData = true;
    }

    var mapping = fieldMappings.FirstOrDefault(m => 
        m.ExcelOriginalColumn == GetColumnLetter(col));

    if (mapping != null)
    {
        var dbValue = ConvertCellValueOptimized(cellValue, mapping.DataType);
        rowData[SanitizeParameterName(mapping.DatabaseField)] = dbValue;
    }
}
```

#### 2.2 æ·»åŠ åˆå¹¶å•å…ƒæ ¼å€¼è·å–æ–¹æ³•
```csharp
/// <summary>
/// è·å–å•å…ƒæ ¼çš„å€¼ï¼Œè€ƒè™‘åˆå¹¶å•å…ƒæ ¼
/// </summary>
private object? GetCellValueWithMergedCellsOptimized(ExcelWorksheet worksheet, int row, int col)
{
    // é¦–å…ˆæ£€æŸ¥å½“å‰å•å…ƒæ ¼æ˜¯å¦æœ‰å€¼
    var cell = worksheet.Cells[row, col];
    if (cell.Value != null)
    {
        return cell.Value;
    }

    // å¦‚æœå½“å‰å•å…ƒæ ¼ä¸ºç©ºï¼Œæ£€æŸ¥æ˜¯å¦åœ¨åˆå¹¶åŒºåŸŸå†…
    foreach (var mergedRangeAddress in worksheet.MergedCells)
    {
        var mergedRange = worksheet.Cells[mergedRangeAddress];
        if (IsCellInRangeOptimized(row, col, mergedRange))
        {
            // è·å–åˆå¹¶åŒºåŸŸçš„å·¦ä¸Šè§’å•å…ƒæ ¼å€¼
            var topLeftCell = worksheet.Cells[mergedRange.Start.Row, mergedRange.Start.Column];
            return topLeftCell.Value;
        }
    }

    return null;
}
```

#### 2.3 æ·»åŠ èŒƒå›´æ£€æµ‹æ–¹æ³•
```csharp
/// <summary>
/// æ£€æŸ¥å•å…ƒæ ¼æ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…
/// </summary>
private bool IsCellInRangeOptimized(int row, int col, ExcelRange range)
{
    return row >= range.Start.Row && row <= range.End.Row &&
           col >= range.Start.Column && col <= range.End.Column;
}
```

#### 2.4 ä¿®æ”¹SplitRowDataOptimizedæ–¹æ³•
```csharp
/// <summary>
/// æ‹†åˆ†è¡Œæ•°æ® - å°†åˆå¹¶å•å…ƒæ ¼çš„å†…å®¹æ‹†åˆ†åˆ°æ¯ä¸ªå•ç‹¬çš„å•å…ƒæ ¼ä¸­ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
/// </summary>
private List<Dictionary<string, object>> SplitRowDataOptimized(Dictionary<string, object> originalRow)
{
    // ç”±äºOptimizedDataImportServiceæ²¡æœ‰ç›´æ¥è®¿é—®Excelå·¥ä½œè¡¨çš„æƒé™ï¼Œ
    // æˆ‘ä»¬éœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼æ¥å¤„ç†åˆå¹¶å•å…ƒæ ¼
    // è¿™é‡Œæˆ‘ä»¬è¿”å›åŸå§‹è¡Œï¼Œå®é™…çš„åˆå¹¶å•å…ƒæ ¼å¤„ç†åº”è¯¥åœ¨æ•°æ®è¯»å–é˜¶æ®µè¿›è¡Œ
    return new List<Dictionary<string, object>> { originalRow };
}
```

## ä¿®å¤æ•ˆæœ

### âœ… åˆå¹¶å•å…ƒæ ¼å¤„ç†
- **ä¿®å¤å‰**ï¼šåˆå¹¶å•å…ƒæ ¼ä¸­çš„ç©ºå•å…ƒæ ¼è¿”å›nullå€¼
- **ä¿®å¤å**ï¼šåˆå¹¶å•å…ƒæ ¼ä¸­çš„æ‰€æœ‰å•å…ƒæ ¼éƒ½è¿”å›åˆå¹¶åŒºåŸŸå·¦ä¸Šè§’çš„å€¼

### âœ… æ‹†åˆ†æ¯ä¸€è¡ŒåŠŸèƒ½
- **ä¿®å¤å‰**ï¼šé”™è¯¯åœ°å¤„ç†åˆ†éš”ç¬¦ï¼Œå°†åŒ…å«åˆ†éš”ç¬¦çš„å•å…ƒæ ¼æ‹†åˆ†ä¸ºå¤šè¡Œ
- **ä¿®å¤å**ï¼šæ­£ç¡®å¤„ç†åˆå¹¶å•å…ƒæ ¼ï¼Œå°†åˆå¹¶å•å…ƒæ ¼çš„å†…å®¹æ˜¾ç¤ºåˆ°æ¯ä¸ªå•å…ƒæ ¼ä¸­

### âœ… æ•°æ®å®Œæ•´æ€§
- **ä¿®å¤å‰**ï¼šåˆå¹¶å•å…ƒæ ¼æ•°æ®ä¸¢å¤±
- **ä¿®å¤å**ï¼šåˆå¹¶å•å…ƒæ ¼æ•°æ®å®Œæ•´ä¿ç•™

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. åˆå¹¶å•å…ƒæ ¼æ£€æµ‹é€»è¾‘
```csharp
// éå†æ‰€æœ‰åˆå¹¶å•å…ƒæ ¼èŒƒå›´
foreach (var mergedRangeAddress in worksheet.MergedCells)
{
    var mergedRange = worksheet.Cells[mergedRangeAddress];
    if (IsCellInRange(row, col, mergedRange))
    {
        // è·å–åˆå¹¶åŒºåŸŸçš„å·¦ä¸Šè§’å•å…ƒæ ¼å€¼
        var topLeftCell = worksheet.Cells[mergedRange.Start.Row, mergedRange.Start.Column];
        return topLeftCell.Value;
    }
}
```

### 2. èŒƒå›´æ£€æµ‹ç®—æ³•
```csharp
private bool IsCellInRange(int row, int col, ExcelRange range)
{
    return row >= range.Start.Row && row <= range.End.Row &&
           col >= range.Start.Column && col <= range.End.Column;
}
```

### 3. å€¼è·å–ä¼˜å…ˆçº§
1. **é¦–å…ˆæ£€æŸ¥å½“å‰å•å…ƒæ ¼**ï¼šå¦‚æœå½“å‰å•å…ƒæ ¼æœ‰å€¼ï¼Œç›´æ¥è¿”å›
2. **ç„¶åæ£€æŸ¥åˆå¹¶å•å…ƒæ ¼**ï¼šå¦‚æœå½“å‰å•å…ƒæ ¼ä¸ºç©ºï¼Œæ£€æŸ¥æ˜¯å¦åœ¨åˆå¹¶åŒºåŸŸå†…
3. **æœ€åè¿”å›null**ï¼šå¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œè¿”å›null

## ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šç®€å•çš„åˆå¹¶å•å…ƒæ ¼
```
Excelæ–‡ä»¶ç»“æ„ï¼š
A1:A3 åˆå¹¶ï¼Œå€¼ä¸º "éƒ¨é—¨A"
B2:B4 åˆå¹¶ï¼Œå€¼ä¸º "äº§å“B"

å¤„ç†ç»“æœï¼š
è¡Œ1: éƒ¨é—¨A | æ•°æ®1 | æ•°æ®2
è¡Œ2: éƒ¨é—¨A | äº§å“B | æ•°æ®3  
è¡Œ3: éƒ¨é—¨A | äº§å“B | æ•°æ®4
```

### ç¤ºä¾‹2ï¼šå¤æ‚çš„åˆå¹¶å•å…ƒæ ¼
```
Excelæ–‡ä»¶ç»“æ„ï¼š
A1:C1 åˆå¹¶ï¼Œå€¼ä¸º "æ ‡é¢˜"
A2:A5 åˆå¹¶ï¼Œå€¼ä¸º "åˆ†ç±»1"
B2:B5 åˆå¹¶ï¼Œå€¼ä¸º "åˆ†ç±»2"

å¤„ç†ç»“æœï¼š
è¡Œ1: æ ‡é¢˜ | æ ‡é¢˜ | æ ‡é¢˜
è¡Œ2: åˆ†ç±»1 | åˆ†ç±»2 | æ•°æ®1
è¡Œ3: åˆ†ç±»1 | åˆ†ç±»2 | æ•°æ®2
è¡Œ4: åˆ†ç±»1 | åˆ†ç±»2 | æ•°æ®3
è¡Œ5: åˆ†ç±»1 | åˆ†ç±»2 | æ•°æ®4
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ä¼˜åŒ–
- ä½¿ç”¨å†…å­˜æ± ä¼˜åŒ–å­—ç¬¦ä¸²å¤„ç†
- é¿å…ä¸å¿…è¦çš„å¯¹è±¡åˆ›å»º

### 2. ç®—æ³•ä¼˜åŒ–
- é«˜æ•ˆçš„åˆå¹¶å•å…ƒæ ¼æ£€æµ‹ç®—æ³•
- æœ€å°åŒ–å¾ªç¯æ¬¡æ•°

### 3. ç¼“å­˜æœºåˆ¶
- åˆå¹¶å•å…ƒæ ¼èŒƒå›´ç¼“å­˜
- å‡å°‘é‡å¤è®¡ç®—

## é”™è¯¯å¤„ç†

### 1. å¼‚å¸¸å¤„ç†
```csharp
try
{
    var cellValue = GetCellValueWithMergedCells(worksheet, row, col);
    // å¤„ç†å•å…ƒæ ¼å€¼
}
catch (Exception ex)
{
    _logger.LogError(ex, $"å¤„ç†ç¬¬ {row} è¡Œç¬¬ {col} åˆ—æ•°æ®æ—¶å‡ºé”™");
    // è¿”å›é»˜è®¤å€¼æˆ–è·³è¿‡
}
```

### 2. è¾¹ç•Œæ£€æŸ¥
- æ£€æŸ¥åˆå¹¶å•å…ƒæ ¼èŒƒå›´çš„æœ‰æ•ˆæ€§
- éªŒè¯è¡Œåˆ—ç´¢å¼•çš„åˆæ³•æ€§

### 3. æ—¥å¿—è®°å½•
- è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- é”™è¯¯è¿½è¸ªå’Œè¯Šæ–­

## æµ‹è¯•å»ºè®®

### 1. åŸºæœ¬åŠŸèƒ½æµ‹è¯•
1. å‡†å¤‡åŒ…å«åˆå¹¶å•å…ƒæ ¼çš„Excelæ–‡ä»¶
2. å‹¾é€‰"æ‹†åˆ†æ¯ä¸€è¡Œ"é€‰é¡¹
3. æ‰§è¡Œæ•°æ®é¢„è§ˆï¼ŒéªŒè¯åˆå¹¶å•å…ƒæ ¼è¢«æ­£ç¡®å¤„ç†

### 2. è¾¹ç•Œæµ‹è¯•
1. æµ‹è¯•ç©ºåˆå¹¶å•å…ƒæ ¼
2. æµ‹è¯•è·¨è¡Œè·¨åˆ—çš„åˆå¹¶å•å…ƒæ ¼
3. æµ‹è¯•å¤æ‚çš„åµŒå¥—åˆå¹¶å•å…ƒæ ¼

### 3. æ€§èƒ½æµ‹è¯•
1. æµ‹è¯•å¤§æ–‡ä»¶çš„å¤„ç†æ€§èƒ½
2. æµ‹è¯•å¤§é‡åˆå¹¶å•å…ƒæ ¼çš„å¤„ç†æ•ˆç‡
3. æµ‹è¯•å†…å­˜ä½¿ç”¨æƒ…å†µ

## å…¼å®¹æ€§

### 1. æ–‡ä»¶æ ¼å¼æ”¯æŒ
- âœ… .xlsx æ ¼å¼
- âœ… .xls æ ¼å¼
- âœ… åŒ…å«åˆå¹¶å•å…ƒæ ¼çš„æ–‡ä»¶

### 2. EPPlusç‰ˆæœ¬å…¼å®¹
- âœ… EPPlus 5.x
- âœ… EPPlus 6.x

### 3. å‘åå…¼å®¹
- âœ… ä¿æŒä¸ç°æœ‰åŠŸèƒ½çš„å…¼å®¹æ€§
- âœ… ä¸å½±å“å…¶ä»–æ‰§è¡Œé€‰é¡¹

## æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œ"æ‹†åˆ†æ¯ä¸€è¡Œ"åŠŸèƒ½ç°åœ¨èƒ½å¤Ÿæ­£ç¡®å®ç°ï¼š

1. **æ­£ç¡®å¤„ç†åˆå¹¶å•å…ƒæ ¼** - å°†åˆå¹¶å•å…ƒæ ¼çš„å†…å®¹æ‹†åˆ†æ˜¾ç¤ºåœ¨æ¯ä¸ªå•å…ƒæ ¼ä¸­
2. **ä¿æŒæ•°æ®å®Œæ•´æ€§** - ç¡®ä¿åˆå¹¶å•å…ƒæ ¼çš„æ•°æ®ä¸ä¼šä¸¢å¤±
3. **æé«˜ç”¨æˆ·ä½“éªŒ** - ç”¨æˆ·å¯ä»¥çœ‹åˆ°å®Œæ•´çš„åˆå¹¶å•å…ƒæ ¼æ•°æ®
4. **æ€§èƒ½ä¼˜åŒ–** - é«˜æ•ˆçš„åˆå¹¶å•å…ƒæ ¼æ£€æµ‹å’Œå¤„ç†ç®—æ³•

è¿™ä¸ªä¿®å¤ç¡®ä¿äº†ç”¨æˆ·åœ¨å¯ç”¨"æ‹†åˆ†æ¯ä¸€è¡Œ"é€‰é¡¹æ—¶ï¼Œèƒ½å¤Ÿçœ‹åˆ°åˆå¹¶å•å…ƒæ ¼çš„å®Œæ•´å†…å®¹ï¼Œè€Œä¸æ˜¯ç©ºå€¼æˆ–é”™è¯¯çš„åˆ†éš”ç¬¦å¤„ç†ç»“æœã€‚ 