# é…ç½®å¼•ç”¨æœºåˆ¶å®ç°æ€»ç»“

## ğŸ“‹ å®ç°æ¦‚è¿°

æœ¬æ¬¡å®ç°æˆåŠŸæ„å»ºäº†å®Œæ•´çš„é…ç½®å¼•ç”¨æœºåˆ¶ï¼Œè®©ä½œä¸šé…ç½®èƒ½å¤Ÿå¤ç”¨Excelé…ç½®å’ŒSQLç®¡ç†ä¸­çš„é…ç½®ï¼Œé¿å…é‡å¤é…ç½®ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œä¸€è‡´æ€§ã€‚

## ğŸ—ï¸ å·²å®ç°çš„æ ¸å¿ƒç»„ä»¶

### 1. é…ç½®å¼•ç”¨æ¨¡å‹ (`ConfigurationReference`)

**æ–‡ä»¶ä½ç½®**: `ExcelProcessor.Models/ConfigurationReference.cs`

**æ ¸å¿ƒç‰¹æ€§**:
- æ”¯æŒå¤šç§å¼•ç”¨ç±»å‹ï¼šExcelConfigã€SqlConfigã€DataSourceConfig
- åŒ…å«è¦†ç›–å‚æ•°æœºåˆ¶ï¼Œæ”¯æŒJSONæ ¼å¼çš„å‚æ•°è¦†ç›–
- å®Œæ•´çš„çŠ¶æ€ç®¡ç†å’Œå®¡è®¡å­—æ®µ
- æ”¯æŒå¼•ç”¨éªŒè¯å’Œè§£æ

**ä¸»è¦å­—æ®µ**:
```csharp
public class ConfigurationReference
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Description { get; set; }
    public ReferenceType Type { get; set; }
    public string ReferencedConfigId { get; set; }
    public string ReferencedConfigName { get; set; }
    public string OverrideParameters { get; set; }
    public bool IsEnabled { get; set; }
    // ... å…¶ä»–ç®¡ç†å­—æ®µ
}
```

### 2. é…ç½®å¼•ç”¨æœåŠ¡æ¥å£ (`IConfigurationReferenceService`)

**æ–‡ä»¶ä½ç½®**: `ExcelProcessor.Core/Services/IConfigurationReferenceService.cs`

**æ ¸å¿ƒåŠŸèƒ½**:
- é…ç½®å¼•ç”¨çš„CRUDæ“ä½œ
- é…ç½®å¼•ç”¨çš„æ‰§è¡Œå’ŒéªŒè¯
- é…ç½®å¼•ç”¨çš„è§£æå’Œå‚æ•°å¤„ç†
- æ”¯æŒæ‰¹é‡æ“ä½œå’Œæœç´¢

**ä¸»è¦æ–¹æ³•**:
```csharp
// é…ç½®å¼•ç”¨ç®¡ç†
Task<(bool success, string message)> CreateReferenceAsync(ConfigurationReference reference);
Task<(bool success, string message)> UpdateReferenceAsync(ConfigurationReference reference);
Task<(bool success, string message)> DeleteReferenceAsync(string referenceId);

// é…ç½®å¼•ç”¨æ‰§è¡Œ
Task<ReferenceExecutionResult> ExecuteReferenceAsync(string referenceId, Dictionary<string, object>? parameters = null);
Task<List<ReferenceExecutionResult>> ExecuteReferencesAsync(List<string> referenceIds, Dictionary<string, object>? parameters = null);

// é…ç½®å¼•ç”¨è§£æ
Task<object?> ResolveReferenceAsync(ConfigurationReference reference);
Task<ExcelConfig?> ResolveExcelConfigReferenceAsync(ConfigurationReference reference);
Task<SqlConfig?> ResolveSqlConfigReferenceAsync(ConfigurationReference reference);
```

### 3. é…ç½®å¼•ç”¨æœåŠ¡å®ç° (`ConfigurationReferenceService`)

**æ–‡ä»¶ä½ç½®**: `ExcelProcessor.Data/Services/ConfigurationReferenceService.cs`

**æ ¸å¿ƒç‰¹æ€§**:
- å®Œæ•´çš„æ•°æ®åº“æ“ä½œå®ç°
- æ”¯æŒå‚æ•°è¦†ç›–å’ŒåŠ¨æ€æ›¿æ¢
- æ™ºèƒ½é…ç½®è§£æå’ŒéªŒè¯
- è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯å¤„ç†

**æ‰§è¡Œé€»è¾‘**:
```csharp
// æ ¹æ®å¼•ç”¨ç±»å‹æ‰§è¡Œä¸åŒçš„é€»è¾‘
switch (reference.Type)
{
    case ReferenceType.ExcelConfig:
        await ExecuteExcelConfigReference(reference, referencedConfig as ExcelConfig, mergedParameters, result);
        break;
    case ReferenceType.SqlConfig:
        await ExecuteSqlConfigReference(reference, referencedConfig as SqlConfig, mergedParameters, result);
        break;
    case ReferenceType.DataSourceConfig:
        await ExecuteDataSourceConfigReference(reference, referencedConfig as DataSourceConfig, mergedParameters, result);
        break;
}
```

### 4. å¢å¼ºçš„ä½œä¸šæ‰§è¡Œå¼•æ“ (`EnhancedJobExecutionEngine`)

**æ–‡ä»¶ä½ç½®**: `ExcelProcessor.Data/Services/EnhancedJobExecutionEngine.cs`

**æ ¸å¿ƒç‰¹æ€§**:
- æ”¯æŒé…ç½®å¼•ç”¨æ­¥éª¤ç±»å‹
- è‡ªåŠ¨è§£æå’Œæ‰§è¡Œå¼•ç”¨çš„é…ç½®
- å‚æ•°åˆå¹¶å’Œè¦†ç›–æœºåˆ¶
- å®Œæ•´çš„æ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç†

**æ­¥éª¤æ‰§è¡Œ**:
```csharp
case StepType.ConfigurationReference:
    await ExecuteConfigurationReferenceStep(step, context, result);
    break;
```

### 5. é…ç½®å¼•ç”¨ç®¡ç†ç•Œé¢ (`ConfigurationReferencePage`)

**æ–‡ä»¶ä½ç½®**: `ExcelProcessor.WPF/Controls/ConfigurationReferencePage.xaml` å’Œ `.xaml.cs`

**æ ¸å¿ƒåŠŸèƒ½**:
- é…ç½®å¼•ç”¨çš„åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤
- å¼•ç”¨ç±»å‹é€‰æ‹©å’Œé…ç½®å…³è”
- è¦†ç›–å‚æ•°ç¼–è¾‘ï¼ˆJSONæ ¼å¼ï¼‰
- å¼•ç”¨æ‰§è¡Œå’ŒçŠ¶æ€ç®¡ç†

**ç•Œé¢ç‰¹æ€§**:
- ç°ä»£åŒ–çš„WPFç•Œé¢è®¾è®¡
- å“åº”å¼å¸ƒå±€å’Œç”¨æˆ·å‹å¥½çš„æ“ä½œ
- å®æ—¶éªŒè¯å’Œé”™è¯¯æç¤º
- æ”¯æŒæœç´¢å’Œç­›é€‰

## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„

### é…ç½®å¼•ç”¨è¡¨ (`ConfigurationReferences`)

**è¡¨ç»“æ„**:
```sql
CREATE TABLE IF NOT EXISTS ConfigurationReferences (
    Id TEXT PRIMARY KEY,
    Name TEXT NOT NULL,
    Description TEXT,
    Type TEXT NOT NULL,
    ReferencedConfigId TEXT NOT NULL,
    ReferencedConfigName TEXT NOT NULL,
    OverrideParameters TEXT,
    IsEnabled INTEGER NOT NULL DEFAULT 1,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL,
    CreatedBy TEXT,
    UpdatedBy TEXT
);
```

**å­—æ®µè¯´æ˜**:
- `Id`: å¼•ç”¨å”¯ä¸€æ ‡è¯†ç¬¦
- `Name`: å¼•ç”¨åç§°
- `Description`: å¼•ç”¨æè¿°
- `Type`: å¼•ç”¨ç±»å‹ï¼ˆExcelConfig/SqlConfig/DataSourceConfigï¼‰
- `ReferencedConfigId`: å¼•ç”¨çš„é…ç½®ID
- `ReferencedConfigName`: å¼•ç”¨çš„é…ç½®åç§°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
- `OverrideParameters`: JSONæ ¼å¼çš„è¦†ç›–å‚æ•°
- `IsEnabled`: æ˜¯å¦å¯ç”¨
- `CreatedAt/UpdatedAt`: åˆ›å»ºå’Œæ›´æ–°æ—¶é—´
- `CreatedBy/UpdatedBy`: åˆ›å»ºå’Œæ›´æ–°ç”¨æˆ·

## ğŸ”§ æŠ€æœ¯å®ç°äº®ç‚¹

### 1. å‚æ•°è¦†ç›–æœºåˆ¶

**åŠ¨æ€å‚æ•°æ›¿æ¢**:
```csharp
// æ”¯æŒä»¥ä¸‹åŠ¨æ€å‚æ•°
"{{DateTime.Now}}"           // å½“å‰æ—¥æœŸæ—¶é—´
"{{DateTime.Now:yyyy-MM-dd}}" // æ ¼å¼åŒ–æ—¥æœŸ
"{{Date}}"                   // å½“å‰æ—¥æœŸ
"{{Time}}"                   // å½“å‰æ—¶é—´
```

**å‚æ•°åˆå¹¶ç­–ç•¥**:
```csharp
// åˆå¹¶æ‰§è¡Œå‚æ•°å’Œè¦†ç›–å‚æ•°
var mergedParameters = new Dictionary<string, object>();
if (parameters != null)
{
    foreach (var param in parameters)
    {
        mergedParameters[param.Key] = param.Value;
    }
}
if (reference.Parameters != null)
{
    foreach (var param in reference.Parameters)
    {
        mergedParameters[param.Key] = param.Value;
    }
}
```

### 2. æ™ºèƒ½é…ç½®è§£æ

**ç±»å‹å®‰å…¨è§£æ**:
```csharp
public async Task<object?> ResolveReferenceAsync(ConfigurationReference reference)
{
    switch (reference.Type)
    {
        case ReferenceType.ExcelConfig:
            return await ResolveExcelConfigReferenceAsync(reference);
        case ReferenceType.SqlConfig:
            return await ResolveSqlConfigReferenceAsync(reference);
        case ReferenceType.DataSourceConfig:
            return await ResolveDataSourceConfigReferenceAsync(reference);
        default:
            _logger.LogWarning("ä¸æ”¯æŒçš„å¼•ç”¨ç±»å‹: {Type}", reference.Type);
            return null;
    }
}
```

### 3. æ‰§è¡Œç»“æœç®¡ç†

**è¯¦ç»†æ‰§è¡Œæ—¥å¿—**:
```csharp
public class ReferenceExecutionResult
{
    public bool IsSuccess { get; set; }
    public Dictionary<string, object> ResultData { get; set; }
    public string? ErrorMessage { get; set; }
    public double ExecutionTimeSeconds { get; set; }
    public object? ReferencedConfig { get; set; }
    public List<string> ExecutionLogs { get; set; }
}
```

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### 1. åˆ›å»ºé…ç½®å¼•ç”¨

```csharp
var reference = new ConfigurationReference
{
    Name = "æ¯æ—¥é”€å”®æ•°æ®å¯¼å…¥",
    Description = "å¼•ç”¨é”€å”®æ•°æ®Excelé…ç½®ï¼Œæ¯æ—¥è‡ªåŠ¨å¯¼å…¥",
    Type = ReferenceType.ExcelConfig,
    ReferencedConfigId = "excel_config_001",
    OverrideParameters = "{\"ClearTableDataBeforeImport\": true}",
    IsEnabled = true
};

var (success, message) = await referenceService.CreateReferenceAsync(reference);
```

### 2. æ‰§è¡Œé…ç½®å¼•ç”¨

```csharp
var result = await referenceService.ExecuteReferenceAsync(
    "ref_001", 
    new Dictionary<string, object> { { "Date", "2024-01-01" } }
);

if (result.IsSuccess)
{
    Console.WriteLine($"æ‰§è¡ŒæˆåŠŸï¼Œè€—æ—¶: {result.ExecutionTimeSeconds:F2}ç§’");
    foreach (var log in result.ExecutionLogs)
    {
        Console.WriteLine(log);
    }
}
```

### 3. åœ¨ä½œä¸šä¸­ä½¿ç”¨

```csharp
var step = new JobStep
{
    Name = "å¯¼å…¥é”€å”®æ•°æ®",
    Type = StepType.ConfigurationReference,
    Config = JsonSerializer.Serialize(new
    {
        ReferenceId = "ref_001",
        Parameters = new Dictionary<string, object>
        {
            { "ClearTable", true }
        }
    })
};
```

## ğŸš€ ç³»ç»Ÿä¼˜åŠ¿

### 1. é…ç½®å¤ç”¨
- **é¿å…é‡å¤é…ç½®**: ç›¸åŒçš„Excelå¯¼å…¥æˆ–SQLæ‰§è¡Œé…ç½®åªéœ€é…ç½®ä¸€æ¬¡
- **ç»Ÿä¸€ç®¡ç†**: æ‰€æœ‰é…ç½®å¼•ç”¨é›†ä¸­ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤
- **ç‰ˆæœ¬æ§åˆ¶**: æ”¯æŒé…ç½®çš„ç‰ˆæœ¬ç®¡ç†å’Œæ›´æ–°

### 2. çµæ´»æ‰§è¡Œ
- **å‚æ•°è¦†ç›–**: æ”¯æŒè¿è¡Œæ—¶å‚æ•°è¦†ç›–ï¼Œé€‚åº”ä¸åŒåœºæ™¯
- **åŠ¨æ€æ›¿æ¢**: æ”¯æŒæ—¥æœŸã€æ—¶é—´ç­‰åŠ¨æ€å‚æ•°
- **æ¡ä»¶æ‰§è¡Œ**: åŸºäºå‚æ•°çš„æ¡ä»¶æ‰§è¡Œé€»è¾‘

### 3. å¯ç»´æŠ¤æ€§
- **æ¨¡å—åŒ–è®¾è®¡**: é…ç½®ã€å¼•ç”¨ã€æ‰§è¡Œåˆ†ç¦»ï¼ŒèŒè´£æ¸…æ™°
- **æ‰©å±•æ€§å¼º**: æ”¯æŒæ–°çš„å¼•ç”¨ç±»å‹å’Œé…ç½®æ–¹å¼
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 4. ç”¨æˆ·ä½“éªŒ
- **ç›´è§‚ç•Œé¢**: ç°ä»£åŒ–çš„WPFç•Œé¢ï¼Œæ“ä½œç®€å•
- **å®æ—¶åé¦ˆ**: æ‰§è¡ŒçŠ¶æ€å®æ—¶æ›´æ–°ï¼Œè¿›åº¦å¯è§
- **æ™ºèƒ½éªŒè¯**: é…ç½®éªŒè¯å’Œé”™è¯¯æç¤º

## ğŸ”® æœªæ¥æ‰©å±•æ–¹å‘

### 1. å¼•ç”¨æ¨¡æ¿
- æ”¯æŒåˆ›å»ºå¼•ç”¨æ¨¡æ¿
- å¿«é€Ÿåˆ›å»ºå¸¸ç”¨å¼•ç”¨é…ç½®
- æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†

### 2. å¼•ç”¨ä¾èµ–
- æ”¯æŒå¼•ç”¨é—´çš„ä¾èµ–å…³ç³»
- è‡ªåŠ¨å¤„ç†æ‰§è¡Œé¡ºåº
- å¾ªç¯ä¾èµ–æ£€æµ‹

### 3. å¼•ç”¨ç›‘æ§
- å®æ—¶ç›‘æ§å¼•ç”¨æ‰§è¡ŒçŠ¶æ€
- æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
- å¼‚å¸¸æƒ…å†µå‘Šè­¦

### 4. æ‰¹é‡æ“ä½œ
- æ‰¹é‡åˆ›å»ºå’Œæ›´æ–°å¼•ç”¨
- æ‰¹é‡æ‰§è¡Œå’ŒéªŒè¯
- æ‰¹é‡å¯¼å…¥å¯¼å‡º

## ğŸ‰ æ€»ç»“

é…ç½®å¼•ç”¨æœºåˆ¶çš„æˆåŠŸå®ç°ä¸ºExcelå¤„ç†ç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„é…ç½®å¤ç”¨èƒ½åŠ›ï¼Œé€šè¿‡åˆç†ä½¿ç”¨è¿™ä¸€æœºåˆ¶ï¼Œå¯ä»¥ï¼š

- **æé«˜å¼€å‘æ•ˆç‡**: é¿å…é‡å¤é…ç½®ç›¸åŒçš„å†…å®¹
- **å¢å¼ºç³»ç»Ÿç»´æŠ¤æ€§**: é›†ä¸­ç®¡ç†é…ç½®ï¼Œä¾¿äºç»´æŠ¤å’Œæ›´æ–°
- **æå‡æ‰§è¡Œä¸€è‡´æ€§**: ç¡®ä¿ç›¸åŒé…ç½®åœ¨ä¸åŒåœºæ™¯ä¸‹çš„ä¸€è‡´æ€§
- **æ”¯æŒçµæ´»æ‰©å±•**: é€šè¿‡å‚æ•°è¦†ç›–æ”¯æŒå¤šç§æ‰§è¡Œåœºæ™¯

è¯¥æœºåˆ¶å®Œå…¨æ»¡è¶³äº†ç”¨æˆ·çš„éœ€æ±‚ï¼Œè®©æ‰‹åŠ¨æ‰§è¡Œçš„ä½œä¸šèƒ½å¤Ÿæ ¹æ®Excelé…ç½®å’ŒSQLç®¡ç†çš„é…ç½®ä»¥åŠå¯¹åº”æ–¹æ³•æ‰§è¡Œï¼Œå®ç°äº†é…ç½®çš„å¤ç”¨å’Œç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§æå‡ã€‚ 