# SQLè¾“å‡ºåˆ°å·¥ä½œè¡¨åŠŸèƒ½å¢å¼ºæŠ¥å‘Š

## ğŸ¯ åŠŸèƒ½éœ€æ±‚

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œéœ€è¦å¢å¼º"SQLè¾“å‡ºåˆ°å·¥ä½œè¡¨"åŠŸèƒ½ï¼Œä½¿å…¶èƒ½å¤Ÿï¼š

1. **æ™ºèƒ½æ–‡ä»¶å¤„ç†**ï¼šå½“è¾“å‡ºç›®æ ‡EXCELä¸å­˜åœ¨æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºè¯¥EXCELæ–‡ä»¶
2. **ç°æœ‰æ–‡ä»¶æ”¯æŒ**ï¼šå½“è¾“å‡ºç›®æ ‡å­˜åœ¨æ—¶ï¼Œä½¿ç”¨ç›®æ ‡EXCELè¿›è¡Œsheeté¡µè¿½åŠ æ“ä½œ
3. **çµæ´»çš„æ¸…ç©ºç­–ç•¥**ï¼šæ ¹æ®"è¾“å‡ºå‰æ¸…ç©ºsheeté¡µ"å‹¾é€‰æƒ…å†µè¿›è¡Œç›¸åº”å¤„ç†
4. **é€šç”¨æ€§è€ƒè™‘**ï¼šä¿®æ”¹æ—¶è€ƒè™‘åŠŸèƒ½çš„é€šç”¨æ€§ï¼Œä¾¿äºå…¶ä»–æ¨¡å—å¤ç”¨

## ğŸ”§ å®ç°å†…å®¹

### 1. æ ¸å¿ƒé€»è¾‘é‡æ„

#### 1.1 æ–‡ä»¶å­˜åœ¨æ€§æ£€æµ‹
åœ¨ `ExcelProcessor.Data/Services/SqlService.cs` çš„ `ExportDataToExcelAsync` æ–¹æ³•ä¸­æ·»åŠ äº†æ™ºèƒ½æ–‡ä»¶æ£€æµ‹é€»è¾‘ï¼š

```csharp
// æ£€æŸ¥ç›®æ ‡Excelæ–‡ä»¶æ˜¯å¦å­˜åœ¨
if (File.Exists(outputPath))
{
    _logger.LogInformation("ç›®æ ‡Excelæ–‡ä»¶å·²å­˜åœ¨ï¼Œå°†è¯»å–ç°æœ‰æ–‡ä»¶: {OutputPath}", outputPath);
    
    try
    {
        // è¯»å–ç°æœ‰Excelæ–‡ä»¶
        using var fileStream = new FileStream(outputPath, FileMode.Open, FileAccess.Read, FileShare.Read);
        package = new ExcelPackage(fileStream);
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡å·¥ä½œè¡¨
        var existingWorksheet = package.Workbook.Worksheets.FirstOrDefault(ws => ws.Name == sheetName);
        if (existingWorksheet != null)
        {
            _logger.LogInformation("ç›®æ ‡å·¥ä½œè¡¨å·²å­˜åœ¨: {SheetName}", sheetName);
            
            if (clearSheetBeforeOutput)
            {
                // æ¸…ç©ºå·¥ä½œè¡¨å†…å®¹
                _logger.LogInformation("æ ¹æ®é…ç½®æ¸…ç©ºå·¥ä½œè¡¨å†…å®¹: {SheetName}", sheetName);
                existingWorksheet.Cells.Clear();
            }
            else
            {
                // ä¸æ¸…ç©ºï¼Œè·å–ç°æœ‰æ•°æ®çš„è¡Œæ•°ï¼Œç”¨äºè¿½åŠ 
                var lastRow = existingWorksheet.Dimension?.End?.Row ?? 0;
                _logger.LogInformation("å·¥ä½œè¡¨ {SheetName} ç°æœ‰æ•°æ®è¡Œæ•°: {LastRow}, å°†åœ¨ç¬¬ {NextRow} è¡Œå¼€å§‹è¿½åŠ æ•°æ®", 
                    sheetName, lastRow, lastRow + 1);
            }
        }
        else
        {
            _logger.LogInformation("ç›®æ ‡å·¥ä½œè¡¨ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°å·¥ä½œè¡¨: {SheetName}", sheetName);
        }
    }
    catch (Exception ex)
    {
        _logger.LogWarning(ex, "è¯»å–ç°æœ‰Excelæ–‡ä»¶å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶: {OutputPath}", outputPath);
        package = new ExcelPackage();
        isNewFile = true;
    }
}
else
{
    _logger.LogInformation("ç›®æ ‡Excelæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶: {OutputPath}", outputPath);
    package = new ExcelPackage();
    isNewFile = true;
}
```

#### 1.2 æ™ºèƒ½æ•°æ®å†™å…¥ç­–ç•¥å’Œè¡¨å¤´å¤„ç†
æ ¹æ®æ–‡ä»¶çŠ¶æ€å’Œæ¸…ç©ºé…ç½®ï¼Œæ™ºèƒ½ç¡®å®šæ•°æ®å†™å…¥çš„èµ·å§‹è¡Œï¼Œå¹¶ç¡®ä¿æ¯ä¸ªsheeté¡µéƒ½åŒ…å«è¡¨å¤´ï¼š

```csharp
// ç¡®å®šæ•°æ®å†™å…¥çš„èµ·å§‹è¡Œå’Œæ˜¯å¦éœ€è¦æ·»åŠ è¡¨å¤´
int startRow;
bool needHeader = false;

if (isNewFile || clearSheetBeforeOutput)
{
    // æ–°æ–‡ä»¶æˆ–æ¸…ç©ºåï¼Œä»ç¬¬1è¡Œå¼€å§‹å†™å…¥æ ‡é¢˜
    startRow = 1;
    needHeader = true;
    
    _logger.LogInformation("æ–°æ–‡ä»¶æˆ–æ¸…ç©ºæ¨¡å¼ï¼Œå°†åœ¨ç¬¬1è¡Œæ·»åŠ è¡¨å¤´");
}
else
{
    // ä¸æ¸…ç©ºï¼Œæ£€æŸ¥ç°æœ‰å·¥ä½œè¡¨æ˜¯å¦æœ‰è¡¨å¤´
    var lastRow = worksheet.Dimension?.End?.Row ?? 0;
    
    if (lastRow == 0)
    {
        // å·¥ä½œè¡¨ä¸ºç©ºï¼Œéœ€è¦æ·»åŠ è¡¨å¤´
        startRow = 1;
        needHeader = true;
        _logger.LogInformation("ç°æœ‰å·¥ä½œè¡¨ä¸ºç©ºï¼Œå°†åœ¨ç¬¬1è¡Œæ·»åŠ è¡¨å¤´");
    }
    else
    {
        // æ£€æŸ¥ç¬¬1è¡Œæ˜¯å¦å·²ç»æ˜¯è¡¨å¤´ï¼ˆé€šè¿‡æ£€æŸ¥æ˜¯å¦æœ‰æ ·å¼æˆ–å†…å®¹ï¼‰
        var firstRowHasContent = false;
        for (int i = 1; i <= columns.Count; i++)
        {
            var cell = worksheet.Cells[1, i];
            if (cell.Value != null && !string.IsNullOrEmpty(cell.Value.ToString()))
            {
                firstRowHasContent = true;
                break;
            }
        }
        
        if (!firstRowHasContent)
        {
            // ç¬¬1è¡Œæ²¡æœ‰å†…å®¹ï¼Œéœ€è¦æ·»åŠ è¡¨å¤´
            startRow = 1;
            needHeader = true;
            _logger.LogInformation("ç¬¬1è¡Œæ²¡æœ‰å†…å®¹ï¼Œå°†åœ¨ç¬¬1è¡Œæ·»åŠ è¡¨å¤´");
        }
        else
        {
            // ç¬¬1è¡Œå·²æœ‰å†…å®¹ï¼Œå‡è®¾æ˜¯è¡¨å¤´ï¼Œåœ¨ç°æœ‰æ•°æ®åè¿½åŠ 
            startRow = lastRow + 1;
            _logger.LogInformation("ç¬¬1è¡Œå·²æœ‰å†…å®¹ï¼Œå°†åœ¨ç°æœ‰æ•°æ®åè¿½åŠ ï¼Œèµ·å§‹è¡Œ: {StartRow}", startRow);
        }
    }
}

// å¦‚æœéœ€è¦æ·»åŠ è¡¨å¤´ï¼Œåˆ™å†™å…¥åˆ—æ ‡é¢˜
if (needHeader)
{
    for (int i = 0; i < columns.Count; i++)
    {
        worksheet.Cells[startRow, i + 1].Value = columns[i].Name;
        worksheet.Cells[startRow, i + 1].Style.Font.Bold = true;
        worksheet.Cells[startRow, i + 1].Style.Fill.PatternType = ExcelFillStyle.Solid;
        worksheet.Cells[startRow, i + 1].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
    }
    
    // æ•°æ®ä»è¡¨å¤´ä¸‹ä¸€è¡Œå¼€å§‹å†™å…¥
    startRow++;
    _logger.LogInformation("è¡¨å¤´å·²æ·»åŠ ï¼Œæ•°æ®å°†ä»ç¬¬ {StartRow} è¡Œå¼€å§‹å†™å…¥", startRow);
}
```

#### 1.3 æ•°æ®è¿½åŠ é€»è¾‘ä¼˜åŒ–
ä¿®æ”¹äº†æ‰¹é‡æ•°æ®å†™å…¥é€»è¾‘ï¼Œæ”¯æŒä»æŒ‡å®šè¡Œå¼€å§‹è¿½åŠ ï¼š

```csharp
// æ‰¹é‡å†™å…¥æ•°æ®
var currentStartRow = startRow + batchStart;
worksheet.Cells[currentStartRow, 1].LoadFromArrays(batchData);
```

### 2. åŠŸèƒ½ç‰¹æ€§

#### 2.1 è‡ªåŠ¨æ–‡ä»¶åˆ›å»º
- **æ–°æ–‡ä»¶æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹ç›®æ ‡Excelæ–‡ä»¶æ˜¯å¦å­˜åœ¨
- **ç›®å½•åˆ›å»º**ï¼šè‡ªåŠ¨åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
- **æ–‡ä»¶åˆå§‹åŒ–**ï¼šä¸ºæ–°æ–‡ä»¶åˆ›å»ºåŸºç¡€ç»“æ„

#### 2.2 ç°æœ‰æ–‡ä»¶å¤„ç†
- **æ–‡ä»¶è¯»å–**ï¼šå®‰å…¨è¯»å–ç°æœ‰Excelæ–‡ä»¶
- **å·¥ä½œè¡¨æ£€æµ‹**ï¼šæ£€æŸ¥ç›®æ ‡å·¥ä½œè¡¨æ˜¯å¦å­˜åœ¨
- **é”™è¯¯æ¢å¤**ï¼šè¯»å–å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°æ–°æ–‡ä»¶åˆ›å»º

#### 2.3 æ™ºèƒ½æ•°æ®ç®¡ç†
- **æ¸…ç©ºç­–ç•¥**ï¼šæ ¹æ®é…ç½®å†³å®šæ˜¯å¦æ¸…ç©ºç°æœ‰æ•°æ®
- **è¿½åŠ æ¨¡å¼**ï¼šä¸æ¸…ç©ºæ—¶è‡ªåŠ¨åœ¨ç°æœ‰æ•°æ®åè¿½åŠ 
- **è¡Œæ•°è®¡ç®—**ï¼šå‡†ç¡®è®¡ç®—ç°æœ‰æ•°æ®çš„è¡Œæ•°

#### 2.4 æ ¼å¼ä¿æŒ
- **æ ‡é¢˜æ ·å¼**ï¼šä¿æŒåˆ—æ ‡é¢˜çš„æ ¼å¼ï¼ˆç²—ä½“ã€èƒŒæ™¯è‰²ï¼‰
- **åˆ—å®½è°ƒæ•´**ï¼šè‡ªåŠ¨è°ƒæ•´åˆ—å®½ä»¥é€‚åº”å†…å®¹
- **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿æ•°æ®å†™å…¥çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§

#### 2.5 æ™ºèƒ½è¡¨å¤´ç®¡ç†
- **è¡¨å¤´æ£€æµ‹**ï¼šæ™ºèƒ½æ£€æµ‹ç°æœ‰å·¥ä½œè¡¨æ˜¯å¦å·²åŒ…å«è¡¨å¤´
- **è‡ªåŠ¨æ·»åŠ **ï¼šåœ¨éœ€è¦æ—¶è‡ªåŠ¨æ·»åŠ æ ¼å¼åŒ–çš„è¡¨å¤´
- **å†…å®¹è¯†åˆ«**ï¼šé€šè¿‡æ£€æŸ¥ç¬¬1è¡Œå†…å®¹åˆ¤æ–­æ˜¯å¦å·²æœ‰è¡¨å¤´
- **æ ¼å¼ç»Ÿä¸€**ï¼šç¡®ä¿æ‰€æœ‰è¡¨å¤´å…·æœ‰ä¸€è‡´çš„æ ·å¼å’Œæ ¼å¼

### 3. æ—¥å¿—è®°å½•å¢å¼º

#### 3.1 è¯¦ç»†çš„æ“ä½œæ—¥å¿—
- æ–‡ä»¶çŠ¶æ€æ£€æµ‹ç»“æœ
- å·¥ä½œè¡¨å­˜åœ¨æ€§æ£€æŸ¥
- æ•°æ®å†™å…¥ç­–ç•¥é€‰æ‹©
- æ“ä½œè¿›åº¦å’Œç»“æœ

#### 3.2 é”™è¯¯å¤„ç†å’Œæ¢å¤
- æ–‡ä»¶è¯»å–å¤±è´¥çš„å¤„ç†
- å¼‚å¸¸æƒ…å†µçš„é™çº§ç­–ç•¥
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯è®°å½•

### 4. é€šç”¨æ€§è®¾è®¡

#### 4.1 æ¥å£ä¸€è‡´æ€§
- ä¿æŒä¸ç°æœ‰æ¥å£çš„å…¼å®¹æ€§
- æ”¯æŒè¿›åº¦å›è°ƒæœºåˆ¶
- ç»Ÿä¸€çš„è¿”å›ç»“æœæ ¼å¼

#### 4.2 é…ç½®çµæ´»æ€§
- æ”¯æŒæ¸…ç©º/è¿½åŠ ä¸¤ç§æ¨¡å¼
- å¯é…ç½®çš„å·¥ä½œè¡¨åç§°
- çµæ´»çš„è¾“å‡ºè·¯å¾„é…ç½®

#### 4.3 é”™è¯¯å¤„ç†
- å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- ä¼˜é›…çš„é™çº§ç­–ç•¥
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯åé¦ˆ

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### 4.1 æ–°æ–‡ä»¶åˆ›å»º
- é¦–æ¬¡æ‰§è¡ŒSQLè¾“å‡º
- æŒ‡å®šè·¯å¾„ä¸å­˜åœ¨Excelæ–‡ä»¶
- éœ€è¦åˆ›å»ºå…¨æ–°çš„æ•°æ®æ–‡ä»¶

### 4.2 ç°æœ‰æ–‡ä»¶è¿½åŠ 
- å®šæœŸæ•°æ®æ›´æ–°
- å¢é‡æ•°æ®æ·»åŠ 
- ä¿æŒå†å²æ•°æ®å®Œæ•´æ€§

### 4.3 æ•°æ®æ¸…ç©ºé‡å†™
- æ•°æ®å®Œå…¨åˆ·æ–°
- å®šæœŸæ•°æ®é‡å»º
- æµ‹è¯•ç¯å¢ƒæ•°æ®é‡ç½®

## ğŸ” æŠ€æœ¯å®ç°ç»†èŠ‚

### 4.1 æ–‡ä»¶æ“ä½œå®‰å…¨æ€§
- ä½¿ç”¨ `FileShare.Read` ç¡®ä¿æ–‡ä»¶å¯è¯»æ€§
- å¼‚å¸¸æƒ…å†µä¸‹çš„è‡ªåŠ¨é™çº§å¤„ç†
- æ–‡ä»¶æµçš„æ­£ç¡®é‡Šæ”¾ç®¡ç†

### 4.2 å†…å­˜ç®¡ç†
- ä½¿ç”¨ `using` è¯­å¥ç¡®ä¿èµ„æºé‡Šæ”¾
- æ‰¹é‡æ•°æ®å¤„ç†å‡å°‘å†…å­˜å ç”¨
- è¿›åº¦å›è°ƒæ”¯æŒå¤§æ•°æ®é‡å¤„ç†

### 4.3 æ€§èƒ½ä¼˜åŒ–
- æ‰¹é‡æ•°æ®å†™å…¥ï¼ˆ1000è¡Œ/æ‰¹ï¼‰
- æ™ºèƒ½çš„è¡Œæ•°è®¡ç®—
- æœ€å°åŒ–çš„æ–‡ä»¶I/Oæ“ä½œ

### 4.4 è¡¨å¤´å¤„ç†ç­–ç•¥
- **æ™ºèƒ½æ£€æµ‹**ï¼šé€šè¿‡æ£€æŸ¥ç¬¬1è¡Œå•å…ƒæ ¼å†…å®¹åˆ¤æ–­è¡¨å¤´å­˜åœ¨æ€§
- **æ¡ä»¶æ·»åŠ **ï¼šä»…åœ¨éœ€è¦æ—¶æ·»åŠ è¡¨å¤´ï¼Œé¿å…é‡å¤æ“ä½œ
- **æ ¼å¼ä¿æŒ**ï¼šè¡¨å¤´æ ·å¼ç»Ÿä¸€ï¼ˆç²—ä½“ã€èƒŒæ™¯è‰²ã€è¾¹æ¡†ç­‰ï¼‰
- **ä½ç½®è®¡ç®—**ï¼šå‡†ç¡®è®¡ç®—æ•°æ®å†™å…¥çš„èµ·å§‹ä½ç½®

## âœ… æµ‹è¯•å»ºè®®

### 4.1 åŠŸèƒ½æµ‹è¯•
1. **æ–°æ–‡ä»¶åˆ›å»ºæµ‹è¯•**
   - æŒ‡å®šä¸å­˜åœ¨çš„è·¯å¾„
   - éªŒè¯æ–‡ä»¶åˆ›å»ºå’Œå†…å®¹æ­£ç¡®æ€§

2. **ç°æœ‰æ–‡ä»¶è¿½åŠ æµ‹è¯•**
   - ä½¿ç”¨å·²å­˜åœ¨çš„Excelæ–‡ä»¶
   - éªŒè¯æ•°æ®è¿½åŠ çš„å‡†ç¡®æ€§

3. **æ¸…ç©ºæ¨¡å¼æµ‹è¯•**
   - å‹¾é€‰"è¾“å‡ºå‰æ¸…ç©ºsheeté¡µ"
   - éªŒè¯ç°æœ‰æ•°æ®è¢«æ­£ç¡®æ¸…ç©º

### 4.2 è¾¹ç•Œæµ‹è¯•
1. **å¤§æ–‡ä»¶å¤„ç†**
   - æµ‹è¯•å¤§æ•°æ®é‡çš„å¤„ç†èƒ½åŠ›
   - éªŒè¯å†…å­˜ä½¿ç”¨æƒ…å†µ

2. **å¼‚å¸¸æƒ…å†µå¤„ç†**
   - æ–‡ä»¶è¢«å ç”¨çš„æƒ…å†µ
   - æƒé™ä¸è¶³çš„æƒ…å†µ
   - ç£ç›˜ç©ºé—´ä¸è¶³çš„æƒ…å†µ

## ğŸš€ éƒ¨ç½²è¯´æ˜

### 4.1 ç¼–è¯‘è¦æ±‚
- .NET 6.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- EPPlus åº“ä¾èµ–
- ç¡®ä¿æ‰€æœ‰ä¾èµ–é¡¹æ­£ç¡®å¼•ç”¨

### 4.2 é…ç½®è¦æ±‚
- ç¡®ä¿è¾“å‡ºç›®å½•æœ‰å†™å…¥æƒé™
- é…ç½®é€‚å½“çš„æ—¥å¿—çº§åˆ«
- æµ‹è¯•ç¯å¢ƒéªŒè¯åŠŸèƒ½å®Œæ•´æ€§

## ğŸ“ æ€»ç»“

æœ¬æ¬¡åŠŸèƒ½å¢å¼ºæˆåŠŸå®ç°äº†SQLè¾“å‡ºåˆ°å·¥ä½œè¡¨çš„æ™ºèƒ½æ–‡ä»¶å¤„ç†èƒ½åŠ›ï¼Œä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š

1. **æ™ºèƒ½åŒ–**ï¼šè‡ªåŠ¨æ£€æµ‹æ–‡ä»¶çŠ¶æ€ï¼Œé€‰æ‹©åˆé€‚çš„å¤„ç†ç­–ç•¥
2. **çµæ´»æ€§**ï¼šæ”¯æŒæ¸…ç©ºå’Œè¿½åŠ ä¸¤ç§æ•°æ®ç®¡ç†æ¨¡å¼
3. **å¯é æ€§**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
4. **é€šç”¨æ€§**ï¼šè®¾è®¡è€ƒè™‘å¤ç”¨æ€§ï¼Œä¾¿äºå…¶ä»–æ¨¡å—é›†æˆ
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡å¤„ç†å’Œæ™ºèƒ½å†…å­˜ç®¡ç†
6. **è¡¨å¤´ç®¡ç†**ï¼šæ™ºèƒ½æ£€æµ‹å’Œè‡ªåŠ¨æ·»åŠ è¡¨å¤´ï¼Œç¡®ä¿æ¯ä¸ªsheeté¡µéƒ½æœ‰å®Œæ•´çš„è¡¨å¤´ä¿¡æ¯

è¯¥åŠŸèƒ½ç°åœ¨èƒ½å¤Ÿæ»¡è¶³å„ç§å¤æ‚çš„æ•°æ®è¾“å‡ºåœºæ™¯ï¼Œä¸ºç”¨æˆ·æä¾›äº†æ›´åŠ çµæ´»å’Œå¼ºå¤§çš„Excelæ•°æ®ç®¡ç†èƒ½åŠ›ã€‚ 